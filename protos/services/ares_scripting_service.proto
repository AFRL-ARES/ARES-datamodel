syntax = "proto3";

package ares.services;

import "google/protobuf/empty.proto";
import "ares_struct.proto";
import "scripting/autocomplete_catalog.proto";
import "scripting/completion.proto";
import "scripting/diagnostic.proto";
import "scripting/script_summary_step.proto";

service AresScriptingService {
    // Executes a script and streams the output.
    rpc ExecuteScript(ScriptExecutionRequest) returns (stream ScriptExecutionEvent);
    
    // Returns the static definition of the world (Namespaces, Globals, etc).
    // Can be used for initial caching on the client side.
    rpc GetAutocompleteCatalog(google.protobuf.Empty) returns (AutocompleteCatalogResponse);
    
    // Dynamic context-aware suggestions based on cursor position.
    rpc GetCompletions(CompletionRequest) returns (CompletionResponse);

    // Checks for syntax errors or invalid variable references without running
    rpc ValidateScript(ValidateScriptRequest) returns (ValidateScriptResponse);

    // Builds an ordered summary of function calls found in the script.
    rpc GetScriptSummary(ScriptSummaryRequest) returns (ScriptSummaryResponse);
}

// --- Execution Messages ---

message ScriptExecutionRequest {
    string script = 1;
}

message ScriptExecutionEvent {
    int64 sequence = 1;

    oneof event {
        ExecutionStarted execution_started = 2;
        ExecutionCompleted execution_completed = 3;
        ExecutionFailed execution_failed = 4;
        ConsoleOutput console_output = 5;
        FunctionStarted function_started = 6;
        FunctionCompleted function_completed = 7;
        FunctionFailed function_failed = 8;
    }
}

message ExecutionStarted {}

message ExecutionCompleted {}

message ExecutionFailed {
    string error = 1;
}

message ConsoleOutput {
    string output = 1;
}

message FunctionStarted {
    string call_id = 1;
    string parent_call_id = 2;
    datamodel.scripting.ScriptFunctionInvocation invocation = 3;
}

message FunctionCompleted {
    string call_id = 1;
    datamodel.AresValue result = 2;
}

message FunctionFailed {
    string call_id = 1;
    string error = 2;
}

// --- Validation Messages ---

message ValidateScriptRequest {
    string script = 1;
}

message ValidateScriptResponse {
    repeated datamodel.scripting.Diagnostic diagnostics = 1;
}

message ScriptSummaryRequest {
    string script = 1;
    bool include_user_functions = 2;
    bool include_lambdas = 3;
}

message ScriptSummaryResponse {
    repeated datamodel.scripting.ScriptFunctionInvocation steps = 1;
    repeated datamodel.scripting.Diagnostic diagnostics = 2;
}

// --- Catalog Messages ---

message AutocompleteCatalogResponse {
    datamodel.scripting.AutocompleteCatalog catalog = 1;
}


// --- Autocomplete Messages ---

message CompletionRequest {
    // Full document text so the server can resolve locals/scope.
    string script = 1;
    // 1-based cursor line.
    int32 cursor_line = 2;
    // 1-based cursor column.
    int32 cursor_column = 3;

    // The character that triggered the completion (e.g. ".")
    string trigger_character = 4;
}

message CompletionResponse {
    repeated datamodel.scripting.CompletionItem items = 1;
}
